<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deck Editor - Powell's Bowells</title>
    <link rel="stylesheet" href="styles/style.css">

    <link rel="stylesheet" href="../frontend/styles/deck-editor.css">
</head>

<body>
  <header>
    <div class="header-brand">
      <img src="../design/logo.png" alt="Powell's Bowells Logo">
      <span>Powell's Bowells</span>
    </div>
    <nav class="header-nav">
      <nav class="nav-links">
        <a href="../frontend/landingPage.html">Home</a>
        <a href="../frontend/restaurant-form.html">Add Restaurant</a>
        <a href="../frontend/card-deck.html">Decks</a>
      </nav>
    </nav>
    <button class="change-deck-photo-button">Change Deck Photo</button>
  </header>

  <main class="main-content">
    <div class="deck-title-container">
      <h1 class="deck-title">Deck Title</h1>
    </div>

    <div class="restaurant-grid-wrapper">
      <div class="restaurant-grid">

      </div>
    </div>
  </main>

  <footer id = "footer">
    <div class="header-brand">
      <img src="../design/logo.png" alt="Powell's Bowells Logo">
      <span>Powell's Bowells</span>
    </div>
    <div style="text-align: right; line-height: 1.6; font-size: 13px;">
      <div style="font-weight: bold;">Contact Us</div>
      <div>Email: hello@powellsbowells.com</div>
      <div>Phone: (123) 456-7890</div>
    </div>
  </footer>
    <script src="../frontend/js/deckControllerFrontEnd.js"></script>
    <script src="../frontend/scripts.js"></script>

    <script>
        function getDeckIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get("deck");
        }

        function renderDeckEditor() {
            const deckId = getDeckIdFromUrl();

            //debug localstorage
            const rawData = localStorage.getItem('restaurantsData');
            console.log("Raw localStorage data:", rawData);
            console.log("Parsed localStorage:", JSON.parse(rawData || '{}'));
            
            const availableDecks = getDecks();
            const deck = availableDecks.find(d => d.id === deckId);
            console.log("Deck ID from URL:", deckId);
            console.log("Available decks:", availableDecks);
            console.log("Deck:", deck);
            console.log("Deck.cards:", deck.cards);

            // Update deck title
            document.querySelector(".deck-title").textContent = deck.name;

            // Clear and populate restaurant grid
            const grid = document.querySelector(".restaurant-grid");
            grid.innerHTML = "";

            // Get all restaurants (static + user created)
            const savedData = JSON.parse(localStorage.getItem('restaurantsData')) || {};
            const userRestaurants = savedData.restaurants || [];
            const allRestaurants = [...(window.defaultStaticRestaurants || []), ...userRestaurants];
            
            deck.cards.forEach(cardId => {
                const restaurant = allRestaurants.find(r => r.title === cardId);
                if (!restaurant) {
                    console.log(`Restaurant not found: ${cardId}`);
                    return;
                }

                const cardDiv = document.createElement("div");
                cardDiv.className = "restaurant-card";

                cardDiv.innerHTML = `
                    <button class="delete-restaurant-btn" aria-label="Remove restaurant from deck">Ã—</button>
                    <div class="restaurant-card-image">
                        <img src="${restaurant.image}" alt="${restaurant.title}">
                    </div>
                    <div class="restaurant-title">${restaurant.title}</div>
                `;

                // Make the restaurant card clickable (except the delete button)
                cardDiv.addEventListener('click', (e) => {
                    // Don't navigate if clicking the delete button
                    if (e.target.classList.contains('delete-restaurant-btn')) {
                        return;
                    }
                    
                    // Save restaurant data to sessionStorage and navigate
                    console.log('Navigating to restaurant:', restaurant);
                    sessionStorage.setItem('selectedRestaurant', JSON.stringify(restaurant));
                    window.location.href = 'inside-card.html';
                });

                // Add delete functionality
                const deleteBtn = cardDiv.querySelector('.delete-restaurant-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent card click
                    
                    if (confirm(`Remove "${restaurant.title}" from this deck?`)) {
                        const success = window.removeCardFromDeck(deckId, restaurant.title);
                        if (success) {
                            console.log(`Removed ${restaurant.title} from deck ${deckId}`);
                            cardDiv.remove(); // Remove from UI immediately
                        } else {
                            alert('Failed to remove restaurant from deck');
                        }
                    }
                });

                grid.appendChild(cardDiv);
            });
        }

        // Run on load
        document.addEventListener("DOMContentLoaded", renderDeckEditor);
    </script>

</body>

</html>